![[attachments/大数据分析算子算法分析 2025-01-16 16.22.06.excalidraw]]## 整体设计

大数据引擎是处理海量数据的主要抓手，按照业务特征主要分为以下几类：

1. 批处理：
## 关键算子

### HashAgg


![[attachments/大数据分析算子算法分析 2025-01-16 16.24.52.excalidraw]]

HashAgg 主要用于针对某些列进行分组，同时针对另外一些列求聚合运算的操作。

OmniRuntime HashAgg 算子的实现主要步骤如下：

1. 序列化 group by 列，算出序列化后字符串的 hash 值，对数组取模后，

    a. 如果该槽位为空，则直接放入该槽位

    b. 如果槽位不为空，则比较其真实数据  

        i. 如果真实数据相等，则将其state值放入AggStateArray对应行号，以便后期一次性计算整个VectorBatch。注意：这里没有采用就地更新state的方法  

        ii.如果真实数据不等，将槽位+1，重复步骤a 判断下一个槽位的状况  

2. 根据 AggStateArray 批量计算一个 vectorBatch

### Sort  
![[Pasted image 20230731203741.png](attachments/Pasted%20image%2020230731203741.png)

Sort 主要对全量数据进行排序，其重点是如何在大数据量下组织数据进行排序。

OmniRuntime Sort 算子主要需要累积数据，然后根据 Sort Key 进行快排。

1. 累积数据的工作主要由 PageIndex 完成，其通过将不同 VectorBatch 统一编码到一个叫 valueAddress 的数组来实现对所有数据行的访问。

2. 然后构造一个 valuePtrs pair，first 为排序 key，second 为 valueAddress，进而全局排序

3. 针对多个排序列的情况，在第一列已经排好的情况下，对第一列的相同值，刷新 pair 的 first 为第二排序列的值，继续排序

4. 最后根据排序后 pair，构造输出

### HashJoin
![[Pasted image 20230731203754.png](attachments/Pasted%20image%2020230731203754.png)

Join 是指将两张表根据 join key 进行关联，并输出某些列的操作。

presto 在传给 LookupJoinOperatorFactory 的类中，附带了所有的 build 侧的 hashtable 信息，在 probe 时，LookupJoinOperator 需要找到对应分区的 hashtable 进行 join。

而 Spark 的实现则简单一些，一个 LookupJoinOperator 对应一个 hashtable，且当 hashtable 完成后，lookupJoinOp 才开始构建。

HashJoin 算子主要分为两个阶段

###### 阶段一：构建 HashTable

1. 接受输入 VB，构建出 PageIndex

2. 计算每列的 join key 的 hash 值，如果多列，则求 combineHash 值

3. 建立 hash 表的核心数据结构 int* key，

    a. 如果数组的槽位没被填充，则直接令 key[hash]=VA

    b. 被填充，如果 hash 值和数据真实相等，那么填充 positionLinks，将新 VA 指向旧 VA，同时令 key[hash]=新 VA  
     如果不相等，则递增 hash 值，试探下一槽位  

###### 阶段二：Join  

1. probe 侧输入一个 page，计算出整个 page 列对应 join key 的 hash 值

2. 对 probe 的每一行，通过 GetJoinPosition 得到 joinPosition（VA），获取方法为计算出 probe 行的 hash 值，如果 key[hash]不为空，且值与 joinPosition 解析出的 build 数据行侧相同
3. 如果有 join 条件为表达式，则解析出 build 和 probe 的值，通过 simplefilter 进行计算
4.  记录下 probe 和 build 的行号信息，以便后续构造使用
5.  如果 positionLinks[joinPosition]的 value 不为空，则获取该 value 作为新的 joinPosition 重复 Step2
6. 构造 probe 和 build 侧的数据
    - probe 侧数据根据选中的情况，分为完全复用，slice 部分数据，dict 输出
    - build 侧根据 step2.2记录的 VA 信息，解析出行数据，并复制到 output 中   
![[Pasted image 20230731203806.png](attachments/Pasted%20image%2020230731203806.png)
